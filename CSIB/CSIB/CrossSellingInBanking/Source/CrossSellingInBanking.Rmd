---
title: '<br>
 <img style="background: #FDE70F;" src="https://www.fhnw.ch/de/++theme++web16theme/assets/media/img/fachhochschule-nordwestschweiz-fhnw-logo.svg" alt="FHNW Logo" height="50rem" id="logo">
  <br><br>Challenge: Cross Selling in Banking (CED1)'
author: Gisler Luca, Heeb Christian, Studer Aaron, Bécheiraz Léonie
date: "`r format(Sys.time(), '%d.%m.%y')`"
output:
   html_document:
      toc: true
      toc_depth: 6
      toc_float: true
      collapsed: false
      code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE,
                      warning = FALSE)
```

```{=html}
<style type="text/css" media="screen">
h1, h2, h3 {
    color: #4D4D4D;
   }

.list-group-item.active {
    background-color: #FDE70F;
    border-color: #FDE70F;
    color: #4D4D4D;
    font-weight: bold;
}

#logo {
    padding-left: 1rem;
}

</style>
```
## Aufgabenstellung

### Allgemein

Eine tschechische Bank möchte ihre Dienstleistungen für Privatkunden verbessern und "interessante Kundengruppen" identifizieren. Die Geschäftsleitung hat keine präzise Vorstellung, möchte aber zusätzliches Business generieren ohne unnötige Risiken einzugehen und Verluste einzufahren.

Der analytische Auftrag umfasst die folgenden Aufgaben:

-   Qualität und Repräsentativität der Daten zu überprüfen
-   Die Verteilung der einzelnen Datenattribute zu erheben
-   Deren Veränderung über die Zeit zu analysieren
-   Korrelationen zwischen verschiedenen Datenattributen zu quantifizieren und zu visualisieren sowie Hypothesen hinsichtlich optimaler Produktverkauf / -nutzung zu erstellen

### Datengrundlage

Wir erhalten die Daten von einer Tschechischen Bank. Die Datengrundlage ist auf [dieser Webseite](https://sorry.vse.cz/~berka/challenge/PAST/index.html) beschrieben.

## Datenbeschreibung
Die Datengrundlage enthält 8 verschiedene Tabellen (Data Frames) im .csv Format mit Total 47 Attributen. Diese Tabellen mit den jeweiligen Attributen werden hier genauer beschrieben.

Relation disposition (df_raw_disposition): 
disp_id:	    record identifier	
client_id:	  identification of a client	
account_id:	  identification of an account	
type:	        type of disposition (owner/user)	only owner can issue permanent orders and ask for a loan


#### ERD Daten IST-Zustand

![ERD Daten IST-Zustand](../Ressources/IST-Zustand.png)

## Setup

```{r}
library(tidyverse)
library(ggmosaic)
library(ggalluvial)
library(DALEXtra)
library(visdat)
library(DT)
library(patchwork)
library(ggpubr)
library(rpart.plot)
library(tidymodels)
library(lubridate)
tidymodels_prefer()
```

### Setup Account Data Frame

In diesem Schritt wird das Data Frame Account vorbereitet und der 'Transform'-Schritt wird durchgeführt.

```{r}

df_raw_account <- read.csv("../xselling_banking_data/account.csv", header = TRUE, sep = ";")

str(df_raw_account)

```

Es wird wie folgt die Spalte 'date' von dem Type Integer zu dem Typ Date umgewandelt. Dabei brauchen wir die Funktionalitäten von [Lubridate](https://lubridate.tidyverse.org/). Die Spalte 'frequency' ist eine kategoriale Variable mit Tschechischen Werten, daher transformieren wir auch diese Werte auf Englisch.

```{r}

df_account <- df_raw_account %>%
  mutate(date = ymd(date)) %>%
  mutate(frequency = case_when(frequency == "POPLATEK MESICNE" ~ "Monthly",
                              frequency == "POPLATEK TYDNE" ~ "Weekly",
                              frequency == "POPLATEK PO OBRATU" ~ "After_Transaction")
  ) %>%
  arrange(account_id)

rm(df_raw_account)
```

### Setup Client Data Frame

In diesem Schritt wird das Data Frame Account vorbereitet und der 'Transform'-Schritt wird durchgeführt.

```{r}
df_raw_client <- read.csv("../xselling_banking_data/client.csv", header = TRUE, sep = ";")

str(df_raw_client)

```

Es wird wie folgt die Spalte 'birth_number' von dem Type Integer zu dem Typ Date umgewandelt, zusätzlich nennen wir die Spalte neu 'dateofbirth'. Dabei brauchen wir die Funktionalitäten von [Lubridate](https://lubridate.tidyverse.org/). Es wird eine neue Spalte 'sex' hinzugefügt, mithilfe der Dokumentation der Daten kennen wir die Kondition, welches Geschlecht der Kunde hat.

```{r}

df_client <- df_raw_client %>%
  mutate(dateofbirth = case_when(
    strtoi(substr(as.character(birth_number), 3, 3)) > 1 ~ (ymd(birth_number - 5000)),
    TRUE ~ (ymd(birth_number)),
  )) %>%
  mutate(sex = case_when(
    strtoi(substr(as.character(birth_number), 3, 3)) > 1 ~ "Female",
    TRUE  ~ "Male"
  ))

df_client <- df_client %>%
 mutate(dateofbirth = case_when(
   year(ymd(dateofbirth)) > 2000 ~ ymd(dateofbirth) - years(100),
   TRUE ~ ymd(dateofbirth)
 )) %>%
 select(client_id, district_id, dateofbirth, sex) %>%
 arrange(client_id) 

rm(df_raw_client)
```
### Setup Disposition Data Frame

In diesem Schritt wird das Data Frame Disposition vorbereitet und der 'Transform'-Schritt wird durchgeführt.

```{r}
df_raw_disposition <- read.csv("../xselling_banking_data/disp.csv", header = TRUE, sep = ";")

str(df_raw_disposition)

```

In dem Date Frame disposition müssen keine weitere Schritte erledigt werden für das Transformieren der Daten.

```{r}

df_disposition <- df_raw_disposition %>%
 select(disp_id, client_id, account_id, type) %>%
 arrange(disp_id) 

rm(df_raw_disposition)
```

### Setup Order Data Frame

In diesem Schritt wird das Data Frame Order vorbereitet und der 'Transform'-Schritt wird durchgeführt.

```{r}
df_raw_perm_order <- read.csv("../xselling_banking_data/order.csv", header = TRUE, sep = ";")

str(df_raw_perm_order)

```

In dem Data Frame perm_order müssen wir die kategoriale Variable 'k_symbol' noch übersetzen, da der Name 'k_symbol' nicht ausschlaggeben ist, benennen wir die Spalte zu 'payment_type' um.

```{r}

df_perm_order <- df_raw_perm_order %>%
 mutate(payment_type = case_when(k_symbol == "POJISTNE" ~ "INSURRANCE",
                              k_symbol == "SIPO" ~ "HOUSEHOLD",
                              k_symbol == "LEASING" ~ "LEASING",
                              k_symbol == "UVER" ~ "LOAN",
                              TRUE ~ "UNKNOWN")
 ) %>%
 select(order_id, account_id, bank_to, account_to, amount, payment_type) %>%
 arrange(order_id) 

rm(df_raw_perm_order)
```

### Setup Transaction Data Frame

In diesem Schritt wird das Data Frame Transaction vorbereitet und der 'Transform'-Schritt wird durchgeführt.

```{r}
df_raw_transaction <- read.csv("../xselling_banking_data/trans.csv", header = TRUE, sep = ";")

str(df_raw_transaction)

```

Es wird wie folgt die Spalte 'date' von dem Type Integer zu dem Typ Date umgewandelt. Dabei brauchen wir die Funktionalitäten von [Lubridate](https://lubridate.tidyverse.org/). Die Spalte 'type' muss von Tschechisch noch auf Englisch übersetzt werden. Dasselbe zählt auch für die Spalte 'operation' und 'k_symbol'. Jedoch benennen wir die Splate 'k_symbol' noch um in die neue Spalte 'characterization'.

```{r}

df_transaction <- df_raw_transaction %>%
 mutate(date = ymd(date)) %>%
 mutate(type = case_when(type == "PRIJEM" ~ "CREDIT",
                         type == "VYDAJ" ~ "WITHDRAWAL") 
 ) %>%
 mutate(operation = case_when(operation == "VYBER KARTOU" ~ "CREDIT CARD WITHDRAWAL",
                              operation == "VKLAD" ~ "CASH CREDIT",
                              operation == "PREVOD Z UCTU" ~ "COLLECTION OTHER BANK",
                              operation == "VYBER" ~ "CASH WIDTHDRAWAL",
                              operation == "PREVOD NA UCET" ~ "REMITTANCE OTHER BANK")
 ) %>%
 mutate(characterization = case_when(k_symbol == "POJISTNE" ~ "INSURRANCE PAYMENT",
                              k_symbol == "SLUZBY" ~ "STATEMENT PAYMENT",
                              k_symbol == "UROK" ~ "CREDIT INTEREST",
                              k_symbol == "SANKC. UROK" ~ "SANCTION INTEREST",
                              k_symbol == "SIPO" ~ "HOUSEHOLD",
                              k_symbol == "DUCHOD" ~ "OLD AGE PENSION",
                              k_symbol == "UVER" ~ "LOAN PAYMENT")
 ) %>%
 select(trans_id, account_id, date, type, operation, amount, balance, characterization, bank, account) %>%
 arrange(trans_id) 

rm(df_raw_transaction)
```

### Setup Loan Data Frame

In diesem Schritt wird das Data Frame Loan vorbereitet und der 'Transform'-Schritt wird durchgeführt.

```{r}
df_raw_loan <- read.csv("../xselling_banking_data/loan.csv", header = TRUE, sep = ";")

str(df_raw_loan)

```

Es wird wie folgt die Spalte 'date' von dem Type Integer zu dem Typ Date umgewandelt. Dabei brauchen wir die Funktionalitäten von [Lubridate](https://lubridate.tidyverse.org/). Die Spalte 'status' besitzt Enum-Werte. Diese Werte transformieren wir von A, B, C und D zu den entsprechenden Bedeutungen auf English. 

```{r}

df_loan <- df_raw_loan %>%
 mutate(date = ymd(date)) %>%
 mutate(status = case_when(status == "A" ~ "CONTRACT FINISHED PAYED",
                              status == "B" ~ "CONTRACT FINISHED UNPAID",
                              status == "C" ~ "CONTRACT OPEN OK",
                              status == "D" ~ "CONTRACT OPEN INDEBT",
                              TRUE ~ "")
 ) %>%
 select(loan_id, account_id, date, amount, duration, payments, status) %>%
 arrange(loan_id) 

rm(df_raw_loan)
```

### Setup Credit Card Data Frame

In diesem Schritt wird das Data Frame Credit Card vorbereitet und der 'Transform'-Schritt wird durchgeführt.

```{r}
df_raw_credit_card <- read.csv("../xselling_banking_data/card.csv", header = TRUE, sep = ";")

str(df_raw_credit_card)

```

Es wird wie folgt die Spalte 'issued' von dem Type Character zu dem Typ Date umgewandelt. Dabei brauchen wir die Funktionalitäten von [Lubridate](https://lubridate.tidyverse.org/). Die Werte der Spalte 'type' werden in Upper Case umgeschrieben für eine klarere Übersicht von kategorialen Variablen über alle Data Frames. 

```{r}

df_credit_card <- df_raw_credit_card %>%
 mutate(issued  = ymd(as.integer(substr(issued, 0, 6)))) %>%
 mutate(type = case_when(type == "junior" ~ "JUNIOR",
                              type == "classic" ~ "CLASSIC",
                              type == "gold" ~ "GOLD",
                              TRUE ~ "")
 ) %>%
 select(card_id, disp_id, type, issued) %>%
 arrange(card_id) 

rm(df_raw_credit_card)
```

### Setup District Data Frame

In diesem Schritt wird das Data Frame District vorbereitet und der 'Transform'-Schritt wird durchgeführt.

```{r}
df_raw_district <- read.csv("../xselling_banking_data/district.csv", header = TRUE, sep = ";")

str(df_raw_district)

```

In dem Date Frame 'district' müssen wir alle Spalten neu benennnen, da die einzelnen Spalten aus der Datenquelle keine Aussage über die Daten drinhat. Daher geben wir jeder Spalte einen passenden Namen.

```{r}

df_district <- df_raw_district %>%
 mutate(district_id  = A1) %>%
 mutate(name = A2) %>%
 mutate(region = A3) %>%
 mutate(inhabitants = A4) %>%
 mutate(municipalities_under_499_inhabitants = A5) %>%
 mutate(municipalities_500_to_1999_inhabitants = A6) %>%
 mutate(municipalities_2000_to_9999_inhabitants = A7) %>%
 mutate(municipalities_over_10000_inhabitants = A7) %>%
 mutate(cities = A9) %>%
 mutate(ratio_urban_inhabitants = A10) %>%
 mutate(average_salary = A11) %>%
 mutate(unemployment_rate_95 = A12) %>%
 mutate(unemployment_rate_96 = A13) %>%
 mutate(enterpreneurs_per_1000_inhabitants = A14) %>%
 mutate(commited_crimes_95 = A15) %>%
 mutate(commited_crimes_96 = A16) %>%
 select(district_id, name, region, inhabitants, municipalities_under_499_inhabitants, municipalities_500_to_1999_inhabitants, municipalities_2000_to_9999_inhabitants, municipalities_over_10000_inhabitants, cities, ratio_urban_inhabitants, average_salary, unemployment_rate_95, unemployment_rate_96, enterpreneurs_per_1000_inhabitants, commited_crimes_95, commited_crimes_96) %>%
 arrange(district_id) 

rm(df_raw_district)
```

### ERD Ist-Zustand

In dem nachfolgend Enitity Relation Diagramm sieht man die Elemente der transformierten Daten.

![ERD Daten IST-Zustand](../Ressources/SOLL-Zustand.png)

## 1. Tabellen zusammenführen und erste Analysen

### Tabellen zusammenführen

Das Data Frame Account steht im Zentrum und beinhaltet die Schlüsselfelder zu fast allen weiteren Tabellen. Deshalb beginnen wir mit dem Account und dem District.
```{r}
df <- left_join(df_account, df_district, by = c("district_id"), suffix = c(".df", ".district"))
```

Nun werden die Tabellen Loan, Order und Disposition angefügt:
```{r}
df <- left_join(df, df_loan, by = c("account_id"), suffix = c(".df", ".loan"))
df <- left_join(df, df_perm_order, by = c("account_id"), suffix = c(".df", ".order"))
df <- left_join(df, df_disposition, by = c("account_id"), suffix = c(".df", ".disposition"))
```

Nun kann die Tabelle mit den Kreditkarten angefügt werden
```{r}
df <- left_join(df, df_credit_card, by = c("disp_id"), suffix = c(".df", ".card"))
```

Es fehlen noch der Client
```{r}
df <- left_join(df, df_client, by = c("client_id", "district_id"), suffix = c(".df", ".client"))
```

und die Tabelle mit den Transaktionen
```{r}
df <- left_join(df, df_transaction, by = c("account_id"), suffix = c(".df", ".transaction"))
```

Nachdem alle Tabellen aneinander gefügt wurden kann das neue Data Frame inspiziert werden.
```{r}
glimpse(df)
```
```{r}
rm(df_account, df_client, df_credit_card, df_disposition,df_district, df_loan, df_perm_order, df_transaction)
```


### Attribute anpassen

Folgende Attribute werden angepasst:
unemployment_rate_95 zu "num"
commited_crimes_95 zu "int"
alle chr zu factor

```{r}
df <- df %>% 
  mutate(
    across(c("unemployment_rate_95"), as.numeric),
    across(c("commited_crimes_95"), as.integer),
    across(where(is.character), as.factor))
   

str(df)
```
```{r}
df %>% 
  map(summary)
```
### Attribute umbenennen

```{r}
df <- rename(df,
    'account_date' = 'date.df',
    'district_name' = 'name',
    'loan_date' = 'date.loan',
    'loan_amount' = 'amount.df',
    'loan_duration' = 'duration',
    'loan_payments' = 'payments',
    'loan_status' = 'status',
    'order_amount' = 'amount.order',
    'order_payment_type' = 'payment_type',
    'disp_type' = 'type.df',
    'card_type' = 'type.card',
    'card_issued' = 'issued',
    'trans_date' = 'date',
    'trans_type' = 'type',
    'account_frequency' = 'frequency'
  )
```

Weitere Spalten umbenennen, damit sie später einfacher zugeordnet und angewählt werden können:
```{r}
df <- rename(df,
    'trans_operation' = 'operation',
    'trans_amount' = 'amount',
    'trans_balance' = 'balance',
    'trans_characterization' = 'characterization',
    'trans_bank' = 'bank',
    'trans_account' = 'account'
  )
```

### Sonderstellung der Werte aus distribution type

Wie wir bei der Datenbeschreibung bereits gelesen haben, enthält disposition_type die Information über die Rechte der Konten. Deshalb wird nun der Eintrag "disponent" in "user" geändert. Denn nur der "owner" hat die nötigen Berechtigungen, um Daueraufträge zu erteilen und Darlehen zu beantragen.
```{r}
levels(df$disp_type)
```

```{r}
df <- df %>% 
  mutate(
    disp_type = case_when(
      disp_type == "OWNER" ~"OWNER",
      disp_type == "DISPONENT" ~ "USER"
    )) %>% 
  mutate(across(where(is.character), as.factor)) 
  
levels(df$disp_type)
```


### Auf Duplikate überprüfen
```{r}
n_distinct(df)
```
Es sind keine Duplikate vorhanden.

### Erste Analysen

Nun werden die Transaktionen genauer untersucht.
Dazu wird Data Frame erstellt mit den relevanten Spalten aus Transaktionen, Loan, Order, Account und Credit Card.
```{r}
transactions <- df %>% 
  select(
    account_id,
    starts_with('trans'),
    ends_with('to'), 
    starts_with('loan'),
    starts_with('order'),
    starts_with('card'),
    )
head(transactions)
```
Das neue Data Frame transactions kann nun inspiziert werden.
```{r}
transactions %>% 
  map(summary)
```
### Untersuchen von NA's

Um die NA's zu untersuchen beginne ich mit den Spalten der Transaktionen, welche für die Art der Transaktion verwendet werden. Es sind dies der type, operation und characterization.

Überprüfen, welche Levels in "type" verwendet werden:
```{r}
levels(transactions$trans_type)
```
Die Spalte trans_type weist zwei Levels auf, wobei es sich bei CREDIT um Gutschriften und bei WITHDRAWAL um Rückzüge handelt.
```{r}
count(transactions, trans_type)
```
An diesem Beispiel ist sehr gut zu erkennen, wie sich die verschiedenen Levels zueinander verhalten.
```{r}
transactions %>% 
  filter(
    account_id == 1
  ) %>% 
  select(
    account_id,
    trans_date,
    trans_amount,
    trans_balance,
    trans_type,
    trans_operation,
    trans_characterization
  ) %>% 
  arrange(trans_date) %>% 
  head()
```

Für einen besseren Überblick werden relevante Spalten ausgewählt und verglichen.
```{r}
transactions %>% 
  select(
    trans_type,
    trans_operation,
    trans_characterization,
    order_payment_type,
    loan_payments,
    loan_status,
    loan_duration,
  ) %>% 
  filter(
    is.na(trans_type)
  ) %>%
  summary()
```
Die Anzahl NA's (33168) ist bei trans_type, und trans_characterization gleich hoch und dafür ist die Anzahl "CASH WIDTHDRAWAL" bei trans_operation mit 33168 ebeso gross. Es könnte sein, dass es sich hier überall um Bargeldbezüge handelt. Dies wird nun genauer angeschaut.

```{r}
transactions %>% 
  select(
    trans_type,
    trans_operation,
    trans_characterization,
    order_payment_type,
    loan_status,
    loan_duration,
  ) %>% 
  filter(
    is.na(trans_type),
    is.na(trans_characterization)
  ) %>% 
  slice_sample(n = 5)
```
```{r}
rm(transactions)
```


Alle NA's in trans_type sind Geldrückzüge/Bezüge. Diese Variable kann entsprechend angepasst werden. Für die richtige Zuordnung der Variablen in trans_characterization braucht es weitere Analysen.

### Erstes Anpassen der Variablen 

Da es sich bei den Variablen in trans_type um Geldein- und ausgänge handelt, werden alle Variablen folgendermassen umbenannt:
Attributname "type" zu "cashflow"
CREDIT zu IN
WITHDRAWAL zu OUT
NA's zu OUT
```{r}
df_mod <- df %>%
  rename(
    order_bank_to = bank_to,
    order_account_to = account_to
    ) %>% 
  mutate(
   trans_cashflow = case_when(trans_type == "WITHDRAWAL" ~ "OUT",
                              trans_type == "CREDIT" ~ "IN",
                              TRUE ~ "OUT"
    )
  ) %>% 
  mutate(across(where(is.character), as.factor))

rm(df)

summary(df_mod$trans_cashflow)
```
Die NA's im Attribut "characterization" sind nicht nur Bargeldbezüge wie wir es in der Analyse von vorhin festgestllt haben. Nun werden diese NA's weiter untersucht.
Vergleich der beiden Attribute trans_operation und trans_characterization.
```{r}
transactions <- df_mod %>% 
  select(
    account_id,
    starts_with('trans'),
    starts_with('loan'),
    starts_with('order'),
    starts_with('card'),
    )

summary(transactions[, c("trans_operation", "trans_characterization")])
```
Es fällt auf, dass die Anzahl NA's (357024) aus trans_operation mit der Anzahl CREDIT INTEREST aus trans_characterization korrespondiert. Dies wollen wir nun genauer untersuchen.

Dabei sollen folgende Fragen beantwortet werden:
1. besteht eine Abhängigkeit zwischen NA's aus "operation" und "CREDIT INTEREST" aus "characterization?
2. welche Abhängigkeiten bestehen zwischen "CASH WIDTHDRAWAL" aus "operation" und den Einträgen in "characterization"?

Diese Fragen werden in den Folgenden Analysen beantwortet.

### Punkt 1:
Besteht eine Abhängigkeit zwischen NA's aus "operation" und "CREDIT INTEREST" aus "characterization?
```{r}
transactions %>% 
 filter(
    is.na(trans_operation)
  ) %>% 
  select(
    trans_operation,
    trans_characterization
  ) %>% 
  summary()
```
Die NA's in "operation" sind "CREDIT INTEREST" aus "trans_characterization". Um dies genauer zu verstehen, müssen diese Variablen im gesamten Data Frame angeschaut werden.
```{r}
transactions %>% 
   filter(
    is.na(trans_operation)
  ) %>% 
  slice_sample(n = 5)
  
```
Es handelt sich hier um Gutschriften. Diese Guthabenzinsen können in der Variable "operation" somit entsprechend angepasst werden.
```{r}
rm(transactions)
```

### Zweites Anpassen der Variablen

Die Variable (NA's in trans_operation) wird angepasst.
```{r}
df_mod <- df_mod %>% 
  mutate(
    trans_operation_case = case_when(
      trans_operation == "CASH CREDIT" ~ "CASH CREDIT",
      trans_operation == "CASH WIDTHDRAWAL" ~ "CASH WIDTHDRAWAL",
      trans_operation == "COLLECTION OTHER BANK" ~ "COLLECTION OTHER BANK",
      trans_operation == "CREDIT CARD WITHDRAWAL" ~ "CREDIT CARD WITHDRAWAL",
      trans_operation == "REMITTANCE OTHER BANK" ~ "REMITTANCE OTHER BANK",
      TRUE ~ "CREDIT INTEREST"
    )
  )%>%
  mutate(across(where(is.character), as.factor))

summary(df_mod$trans_operation_case)
```

Erneuter Überblick über die beiden Spalten
```{r}
df_mod %>% 
  select(
    trans_operation_case,
    trans_characterization
  ) %>% 
  summary()
```
Für die NA's aus trans_characterization braucht es weiterführende Analysen. Dazu filtern wir die NA's und vergleichen mit den weiteren relevanten Spalten in Bezug auf die Geldflüsse.

```{r}
characterization_NA <- df_mod %>% 
  select(
    trans_cashflow,
    account_id,
    trans_operation_case,
    order_payment_type,
    card_issued,
    card_type,
    trans_characterization
  ) %>% 
  filter(
    is.na(trans_characterization)
  ) 

slice_sample(characterization_NA, n = 5)
```

ev. werden die Zusammenhänge mit Gruppieren übersichtlicher:
```{r}
characterization_NA %>% 
  group_by(
    trans_operation_case,
    order_payment_type
  ) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  head()
```
```{r}
rm(characterization_NA)
```

Zum Vergleich wird dieselbe Aufstellung gemacht aber diesmal ohne die NA's auch trans_characterization
```{r}
df_mod %>% 
  filter(
    !is.na(trans_characterization)
  ) %>% 
  group_by(
    trans_operation_case,
    order_payment_type,
    trans_characterization
  ) %>% 
  count() %>% 
  arrange(desc(n)) %>% 
  head()
```
Es gibt 37 verschiedene Kombinationen. Diese alle im Detail zu analysieren würde den aktuellen Rahmen sprengen. Deshalb wird hier vorerst darauf verzichtet und bei den zukünftigen Analysen jeweils die relevanten Spalten miteinbezogen. Eventuell bietet es sich an, zu einem späteren Zeitpunkt neue Attribute mit entprechenden Variablen zu erstellen.


### Punkt 2:
Welche Abhängigkeiten bestehen zwischen "CASH WIDTHDRAWAL" aus "operation" und den Einträgen in "characterization"?
```{r}
df_mod %>% 
  filter(
    trans_operation_case == "CASH WIDTHDRAWAL"
  ) %>% 
  select(
    trans_operation_case,
    trans_characterization
  ) %>% 
  summary()
```
Dies sieht auch nach einer umfassenden Analyse aus, was zum aktuellen Zeitpunkt nicht zielführend ist.

### Überprüfung auf doppelte Werte in den Transaktionen

```{r}
df_mod %>% 
 arrange(desc(trans_id)) %>% 
  head()
```
```{r}
df_mod %>% 
  filter(trans_id == 3682987)
```
Die Überprüfung der korrekten Zusammensetzung der einzelnen Data Frames verlief positiv. Nun kann das konsolidierte Data Frame für die weitere Arbeit erstellt werden.
```{r}

```



### **Erstellen des konsolidierten Data Frames**

Das konsolidierte Data Frame wird und dem Namen **df_cons** gespeichert.
```{r}
rm(x)

df_cons <- df_mod %>% 
  select(
    -trans_type,
    -trans_operation
  ) %>% 
  rename(
    "trans_operation" = "trans_operation_case"
  ) %>% 
  relocate(
    starts_with("account"),
    starts_with("trans"),
    starts_with("order"),
    starts_with("loan"),
    starts_with("card"), 
    starts_with("disp"), 
    client_id, 
    dateofbirth,
    sex
  )

rm(df_mod)
```

Übersicht über die Struktur des konsolidierten Datensatzes.
```{r}
str(df_cons)
```
## 1. Datengrundlage

Die uns zu Grunde liegenden Daten lassen sich als von der Bank sowie als exogen erhoben unterscheiden. 

### a. Wie können die Daten noch weiter gruppiert und angeordnet werden, um eine optimale Grundlage für die Analyse zu bilden? (Luca)

```{r}

```


### b. Wie umfassend sind die Stichproben der Daten der Bank? Und trifft dies für alle einzelnen Datensätze zu? (Luca)

```{r}

```


### Zudem wird die Distribution der Datensätze und deren Qualität überprüft. (Luca)
```{r}

```

### c. Die Datenattribute werden alle auf ihre Verteilung sowie ihre Veränderung über die Zeit analysiert. Dabei werden technische Mittel der explorativen Datenanalyse angewendet. (Luca)
```{r}

```

#### i. Jegliche Datenattribute werden innerhalb des eigenen Datenrahmens analysiert. (Luca)
```{r}

```


## 2. Korrelationsanalysen

Nachdem die Datenattribute einzeln analysiert und geprüft wurden, sollen sie miteinander mittels Korrelationsanalysen betrachtet werden. Dabei sollten anfällige Zusammenhänge entdeckt werden.  
Beispiele für Hypothesen, welche in der Analyse überprüft werden könnten, wären: 

### a. Für die einzelne Datenattribute: 

#### i. In welchem Monat oder Tag wird am meisten Geld abgehoben? (LBZ)

Levels vom Attribut trans_operation ausgeben:
```{r}
levels(df_cons$trans_operation)
```
Es gibt zwei verschiedene Arten von Geldabbuchungen. Erstere ist die Geldabbuchung beziehungsweise Überweisung und die zweite die Abbuchung mittels Kreditkarte. Diese beiden Arten werden getrennt analysiert.
```{r}

cash_withdrawal <- df_cons %>% 
  filter(
    trans_cashflow == "OUT",
    trans_operation == "CASH WIDTHDRAWAL"
  )

card_withdrawal <- df_cons %>% 
  filter(
    trans_cashflow == "OUT",
    trans_operation == "CREDIT CARD WITHDRAWAL"
  )

n_cash <- nrow(cash_withdrawal)
n_card <- nrow(card_withdrawal)

paste("Es wurden", n_cash, "Abbuchungen und", n_card, "Kreditkatenbezüge getätigt.", sep = " ")

rm(n_cash, n_card, cash_withdrawal, card_withdrawal)
```
Für die weiteren Analysen wird eine zusätzliche Spalte für die Quartale eines Jahres benötigt. Dazu wird das Jahr in vier Quartale unterteilt.

```{r}
summary(df_cons$trans_month)
```

```{r}
df_cons <- df_cons %>% 
  mutate(
    trans_quarter_year = case_when(
      (month(trans_date) <= 3) ~ "1. QUARTER",
      (month(trans_date) >= 4 & month(trans_date) <= 6) ~ "2. QUARTER",
      (month(trans_date) >= 7 & month(trans_date) <= 9) ~ "3. QUARTER",
      (month(trans_date) > 9) ~ "4. QUARTER"
    ),
    across(
      where(is.character), 
      as.factor
       )
  ) %>% 
  relocate(trans_quarter_year, .after = trans_date)

summary(df_cons$trans_quarter_year)
```


```{r}
#muss noch angepasst werden, ev. auch anderer geom wählen, Titel etc. ergänzen
df_cons %>% 
  filter(
    trans_cashflow == "OUT",
    trans_operation == "CASH WIDTHDRAWAL",
    year(trans_date) == 1995,
    trans_quarter_year == "1. QUARTER"
    ) %>% 
  ggplot(aes(
    x = account_id,
    y = trans_amount
  )) +
  geom_point()
```

In Tabellenform:
```{r}
df_cons %>% 
  filter(
    trans_cashflow == "OUT",
    trans_operation == "CASH WIDTHDRAWAL"
  ) %>% 
  select(
    trans_amount,
    trans_date,
    account_id
  ) %>% 
  arrange(
    desc(trans_amount)
  ) %>% 
  head
```
```{r}
df_cons %>% 
  filter(
    trans_cashflow == "OUT",
  ) %>% 
  group_by(
    trans_amount,
    trans_operation,
    order_payment_type,
    trans_characterization,
    year(trans_date),
    account_id
  ) %>% 
  count() %>% 
  arrange(desc(trans_amount)) %>% 
  head(20)
```


```{r}
df_cons %>% 
  filter(
    trans_cashflow == "OUT",
    trans_operation == "CREDIT CARD WITHDRAWAL",
    year(trans_date) == 1995,
    trans_quarter_year == "1. QUARTER"
    ) %>% 
  ggplot(aes(
    x = account_id,
    y = trans_amount
  )) +
  geom_jitter(
    alpha = 1,
    width = 30,
    shape = 3,
    color = "white"
  ) +
  labs(
    title = "Credit Card Withdrawal", 
    subtitle = "Withdrawals in 1995, 1st Quarter",
    x = "Account ID",
    y = "Amount [CZK]"
  ) +
  theme_dark()
```

In Tabellenform:
```{r}
df_cons %>% 
  filter(
    trans_cashflow == "OUT",
    trans_operation == "CREDIT CARD WITHDRAWAL"
  )
  select(
    trans_amount,
    trans_date, 
    account_id
  ) %>% 
  arrange(
    desc(trans_amount)
  ) %>% 
  head
```
Die meisten Kreditkartenbezüge sind unter 4000 CZK
```{r}
df_cons %>% 
  filter(
    trans_cashflow == "OUT",
    trans_operation == "CREDIT CARD WITHDRAWAL",
    trans_amount == 8000
  ) %>% 
  count()
```
7 mal wurde 8000 Krone mit der Kreditkarte bezogen

```{r}
df_cons %>% 
  filter(
    trans_cashflow == "OUT",
    trans_operation == "CREDIT CARD WITHDRAWAL",
    trans_amount == 8000
  ) %>% 
  count(account_id)
```
Account Nr. 3654 fällt durch die drei hohen Kreditkartenbezüge auf.

Account 3654 genauer untersuchen: wann wurden die kreditbezüge getätigt, was ist sonst noch auffällig an diesem account? welche client sind damit verbunden? kann eine Aussage bezüglich Art der Client und umfeld gemacht werden?

```{r}

```




#### ii. Zu welchem Zeitpunkt wird am meisten Geld überwiesen? (LBZ)
```{r}

```


#### iii. Welche Datenattribute beschreiben den Kundenstamm und wie können Kundengruppen definiert werden? (LBZ)
```{r}

```


#### iv. Wann hat die Bank neue Kunden gewonnen und wie sieht diese Verteilung über die Zeit aus? (Christian)
```{r}
#Muss noch angepasst werden. Inputdaten fehlerhaft. 

#Filter that every Account only occurs once
df_cons_temp <- df_cons %>%
  group_by(account_date ) %>%
  filter(row_number() == 1)

ggplot(data = df_cons_temp, aes(x = account_date)) +
  geom_histogram(binwidth = 15, fill = "#88B8AC") +
  labs(title = "Opening of Account", subtitle = "subtitle") +
  xlab("Year") +
  ylab("Count") +
  theme_light()


rm(df_cons_temp)
```

#### iv. Wie sieht die Altersverteilung dieser Kunden aus und was kann daraus hergeleitet werden? (Christian)
```{r}
#Change dateofbirth of clients with lubridate and calculate age
df_cons$current_age <- as.numeric(difftime(Sys.Date(), df_cons$dateofbirth, units = "weeks")) / 52.25

#Round Age to the next full Number
df_cons$current_age <- floor(df_cons$current_age)

#Relocate rows so new column "current_age" is next to dateofbirth
df_cons <- df_cons %>%
  relocate(current_age, .after = dateofbirth)


#Create Barplot with distrbution of age 
df_cons_temp <- df_cons %>%
  group_by(account_id) %>%
  filter(row_number() == 1)

  ggplot(data = df_cons_temp, aes(current_age)) +
  geom_bar(fill = "#88B8AC") +
  labs(title = "Distribution of Customer Age", subtitle = "Male and Female combined") +
  xlab("Age in Years") +
  ylab("Count") +
  theme_light()

rm(df_cons_temp)

```

#### v. Wieviel Zins wurden durch Kredite erzeugt und wie sieht die Entwicklung über offene Kredite sowie dem erhaltenen Zins aus? (Aaron)
```{r}

```


#### vi. Wie sieht die Verteilung von Kreditkartentypen auf die Population der Kreditkarten aus? (Aaron)
```{r}

```

#### vii. Wie sieht die Verteilung der Typen von Dispositionen aus? (Aaron)
```{r}

```

#### viii. Was ist der am beliebtesten Modus einer Transaktion? (Aaron)
```{r}

```

#### ix. Aus welchen Gründen (Charakterisierung) werden Transaktion durchgeführt und wie sieht die Verteilung dieser aus? (Aaron)
```{r}

```

#### x. In welchen Distrikten gibt es den höchsten Lohn? (Aaron)
```{r}

```

#### xi. Können neue Sonderangebote/Pakete geschaffen werden für die am meist verdienenden Kunden? (Aaron)
```{r}

```

### b. Für Korrelationen zwischen Datenattributen: 

#### i. Prognosen für die Bank erarbeiten, um festzustellen, ob Kunden ihre Kredite zurückzahlen können. Die Kreditwürdigkeit des Kunden kann mithilfe der Analyse festgestellt werden und bei bereits laufenden Krediten können Massnahmen getroffen werden. 
```{r}

```

#### ii. Wie sieht das Verhältnis der Benutzung von verschiedenen Zahlungsmitteln aller getätigten Transaktionen aus? Wie sieht die Entwicklung auf die Zeit aus? Kann man Prognosen daraus herleiten? Müssen wir das Geschäftsmodell anpassen? 
```{r, warning = FALSE}
#Make plot with count of different Payment methods ("trans_operation") over time
df_cons %>%
  ggplot(mapping = aes(x = trans_date, fill = trans_operation)) +
  geom_histogram(binwidth = 5) +
  facet_wrap(~ trans_operation, ncol = 2, scales = "free_y") +
  labs(title = "Overwiev distribution of Transaction methods used from 1993 to 1999 ", subtitle = "Y-axis set independently", fill = "Method of Transaction" ) +
  xlab("Years") +
  ylab("Count") +
   theme(legend.position = "none") +
  scale_x_date(date_labels="%y",date_breaks ="1 year", date_minor_breaks = "1 month") +
  theme(axis.text.x = element_text(size = 8, angle=90,vjust =0.2)) 

```


#### iii. Wie viele der Kunden verwenden eine Kreditkarte von den Bonusprogrammen? Welche Attribute weisen diese Kunden auf? Können Angebote für spezifische Kundengruppen erstellt werden?
```{r}

```

#### iv. Korrelationsanalyse zwischen den Bankdaten und den soziodemografischen Daten.  

### 1. Gibt es Unterschiede bei den Cashflows der Distrikte? Wieso gibt es diese Unterschiede? Was unterscheidet diese Distrikte? 
```{r}

```

### 2. Wie sieht die Distribution von Kunden in den Distrikten aus im Bezug zu den restlichen Einwohnern? Können durch diese Zahlen neue Werbe-Kampagnen gestartet werden, welche zu einem Zuwachs von Kunden führen? 
```{r}

```

### 3. Wie sieht die Entwicklung des Einkommens im Bezug zu den Prüfvariablen der Arbeitslosenrate und den begangenen Straftaten.  
```{r}

```

#### v. Kann man Unterschiede herleiten, um Geschäfts- und Privatkunden zu unterteilen?  
```{r}

```

#### vi. Wie sieht die Entwicklung der Kredite in Bezug auf Typ und Dauer aus? Kann aus der Grafik ein Trend ausgelesen werden?  
```{r}

```
 

### 3. Welches Potenzial haben jegliche Datenobjekte und mit Hilfe welcher Mittel kann das beste Produkt daraus generiert werden?  (Aaron) und jeder der noch kann....
```{r}

```

